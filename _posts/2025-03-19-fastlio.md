# lidar inertial odometry算法模块-公式推导

本文主要以“update by scan”的实际实现为基准（2023-5-23），记录基于ESKF实现的“lidar inertial odometry”理论，并以此为基础，继续进行优化。

理论公式在“lidar inertial odometry”模块中能找到具体对应的代码实现。

# 1、状态量说明

首先我们约定符号：

|  变量  |  意义  |
| --- | --- |
|  $x$  |  真值  |
|  $\^{x}$  |  预测值  |
|  $\={x}$  |  更新后的最优估计  |

1.1 **名义状态变量**与**误差状态变量**的说明

**名义状态变量**：以 “$X$” 表示，我们通常说的状态量，以本lio模块为例，名义状态变量包括：旋转、平移、速度、加速度零偏、角速度零偏、重力向量，总共18维(旋转3维):

$X\_t =  \begin{bmatrix}    R\_t \\    p\_t\\   v\_t\\    bg\_t\\   ba\_t \\   g\_t\\ \end{bmatrix}$

lidar inertial odometry模块对应代码如下：

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/7jP2lRDv7DQJq8g5/img/66d29cb4-6a06-4d8a-b136-2db55f17f68c.png)

**误差状态变量：** 以 “ $\delta X$ ” 表示，真实状态与估计状态之间的误差，这就是eskf中的状态。

$\delta X\_t =  \begin{bmatrix}    \delta \theta\_t \\   \delta  p\_t\\   \delta v\_t\\    \delta bg\_t\\   \delta ba\_t \\   \delta g\_t\\ \end{bmatrix}$

名义状态与误差状态之间的关系为：

$X\_t =  \={X}+\delta X\_t$，即：

$\begin{bmatrix}    R\_t \\    p\_t\\   v\_t\\    bg\_t\\   ba\_t \\   g\_t\\ \end{bmatrix} = \begin{bmatrix}    \=R\_t \\    \=p\_t\\   \=v\_t\\    \=bg\_t\\   \=ba\_t \\   \=g\_t\\ \end{bmatrix} \bigoplus\begin{bmatrix}    \delta \theta\_t \\   \delta  p\_t\\   \delta v\_t\\    \delta bg\_t\\   \delta ba\_t \\   \delta g\_t\\ \end{bmatrix} =  \begin{bmatrix}    \=R\_t\* Exp(\delta \theta\_t) \\    \=p\_t+ \delta  p\_t\\   \=v\_t+\delta v\_t\\    \=bg\_t+\delta bg\_t\\   \=ba\_t+ \delta ba\_t\\   \=g\_t+\delta g\_t\\ \end{bmatrix}$

# 2. 状态量的导数

## 2.1 名义状态在连续时间上的导数（todo: 证明旋转的导数。。。）

$\dot{R\_t} = R\_t\* \lfloor(\~{\omega}-bg\_t-\eta\_g)\rfloor$

$\\ \dot{p\_t} = v\_t$

$\\ \dot{v\_t} = R\_t(\~{a}-ba\_t-\eta\_a)-g$

$\\ \dot{bg\_t} = \eta\_g$

$\\ \dot{ba\_t} = \eta\_a$

$\\ \dot{g\_t} = 0$

NOTE: $\lfloor V\rfloor$表示向量V的反对称矩阵；本模块实际实现代码中重力为正，即重力向量为（0，0，9.81）

## 2.2 误差状态在连续时间上的导数

TODO: 这里直接写结果，证明过程()后面补充。。。

$\dot{\delta \theta} = -\lfloor(\~{\omega}-bg\_t)\rfloor\delta \theta-\delta b\_g-\eta\_g$

$\\ \dot{\delta  p\_t} =\delta   v\_t$

$\\ \dot{\delta v\_t} = -R\_t\lfloor(\~{a}-ba\_t)\rfloor\delta \theta-R\_t\delta b\_a-\eta\_a-\delta\_g$

$\\ \dot{\delta bg\_t} = \eta\_g$

$\\ \dot{\delta ba\_t} = \eta\_a$

$\\ \dot{\delta g\_t} = 0$

# 3. 状态转移过程（预测过程）

## 3.1 名义状态变量的离散时间递推运动方程

$\^R\_{t+\vartriangle t} = \=R\_t\* Exp((\~{\omega}-\=bg\_t)\vartriangle t))$

$\^p\_{t+\vartriangle t} = \=p\_t+\=v\_t\*\vartriangle t+ {1 \over 2}(\=R\_t(\~{a}-ba\_t) - \=g){\vartriangle t}^2$

$\^v\_{t+\vartriangle t} = \=v\_t+(\=R\_t(\~{a}-\=ba\_t) - \=g)\vartriangle t$

$\^bg\_{t+\vartriangle t} = \=bg\_t$

$\^ba\_{t+\vartriangle t} = \=ba\_t$

$\^g\_{t+\vartriangle t} = \=g\_t$

lidar inertial odometry模块对应代码如下：

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/7jP2lRDv7DQJq8g5/img/695eb4d2-4b6d-42d0-8189-e32ddacd9249.png)

## 3.2 误差状态的转移方程

实际上，对于状态的预测，我们利用名义状态变量的转移方程就可以实现了。然而由于eskf中的状态是误差状态，而且误差状态的协方差对于后续的状态更新至关重要，所以推导出误差状态量的转移方程必不可少

(TODO:过程推导)

$\delta \^\theta\_{t+\vartriangle t} = Exp(-(\~\omega -\^bg\_t)\vartriangle t)\delta  \^\theta\_t-\delta \^bg\_t\vartriangle t+\eta\_\theta$

$\\ \delta  \^p\_{t+\vartriangle t} =\delta  \^p\_t +\delta   \^v\_t\vartriangle t$

$\\ \delta \^v\_{t+\vartriangle t} = (-\^R\_t\lfloor(\~{a}-ba\_t)\rfloor\delta \^\theta\_t)\vartriangle t+\delta \^v\_t-\^R\_t\delta \^ba\_t\vartriangle t-\delta \^g\_t\vartriangle t+\eta\_v$

$\\ \^\delta bg\_{t+\vartriangle t} = \delta \^bg\_t+\eta\_g$

$\\ \^\delta ba\_{t+\vartriangle t} = \delta \^ba\_t+ \eta\_a$

$\\ \delta \^g\_{t+\vartriangle t} = \delta \^g\_t$

将以上方程组写成矩阵形式，从而有：

$\delta \^X\_{t+\vartriangle t}=F\_x \*\delta \^X\_t+\omega$ 

$\begin{bmatrix}    \delta \^\theta\_{t+\vartriangle t}  \\   \delta  \^p\_{t+\vartriangle t} \\   \delta \^v\_{t+\vartriangle t} \\    \^\delta bg\_{t+\vartriangle t} \\   \^\delta ba\_{t+\vartriangle t} \\   \delta \^g\_{t+\vartriangle t} \\ \end{bmatrix} = \begin{bmatrix}    Exp(-(\~\omega -\^bg\_t)\vartriangle t) &0&0&-\vartriangle t &0&0\\    0&I&\vartriangle t&0 &0&0\\   (-\^R\_t\lfloor(\~{a}-ba\_t)\rfloor)\vartriangle t&0&I&0&-\^R\_t\vartriangle t&-\vartriangle t\\    0&0&0&I&0&0&\\   0&0&0&0&I&0& \\   0&0&0&0&0&I\\ \end{bmatrix} \*\begin{bmatrix}    \delta \^\theta\_t  \\   \delta  \^p\_t \\   \delta \^v\_t \\    \^\delta bg\_t \\   \^\delta ba\_t \\   \delta \^g\_t \\ \end{bmatrix} +\begin{bmatrix}    \eta\_\theta  \\   0 \\   \eta\_v \\   \eta\_g \\    \eta\_a \\   0 \\ \end{bmatrix}$

协方差P更新方程为：

$P\_{t+\vartriangle t}=F\_x \*P\_t+F\_w\*Q$ 

lidar inertial odometry模块对应代码如下：

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/7jP2lRDv7DQJq8g5/img/9d76cb22-1b4a-41f5-b044-9fd65e783f9e.png)

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/7jP2lRDv7DQJq8g5/img/8983eab1-25b8-47cb-889a-46855305a5bf.png)

# 4.状态更新

## 4.1 观测方程

一个激光点的观测：一个激光系本体的激光点（$Pt\_{lidar}$）,转换到IMU系（$T^i\_l$），再转到世界系（$T^w\_i$）,此时这个点到其最近的Local map中的5个点组成的面的法向距离为观测残差$z$ ：

$z=h(X)+v=h(\^X+\delta X)+v$，其中， $v$为激光测量噪声

以一个激光点为例：

$z=dist=normal\*(T^w\_i\*T^i\_l\*(Pt\_{lidar}-noise\_{lidar}))+pd\_4\\ =normal\*(T^w\_i\*Pt\_{imu})+pd\_4\\ =normal\*(R^w\_i\*Pt\_{imu}+t^w\_i)+pd\_4$

其中$normal = \begin{bmatrix}    pd\_0& pd\_1& pd\_2 \end{bmatrix}$，而$pd\_0 ，pd\_1，pd\_2，pd\_3$是平面方程参数

这里需要理解：这里的$\^X$是转移方程递推而来，在观测方程中我们把它当作是**常量，变量实际上是**$\delta X$。第一次迭代的时候$\delta X$为$\delta \^X=0$。

观测残差相对于误差状态的Jacobian矩阵为：

$H=\tfrac{\partial h}{\partial \delta X}=\tfrac{\partial h}{\partial X}\*\tfrac{\partial X}{\partial \delta X}$

从点面距离残差函数可以看出：激光点的观测残差只与状态量中的旋转和平移相关，所以残差对其他变量的导数全为0。分别对链式乘法的两部分分析，

第一部分对旋转求导：

$\tfrac{\partial (normal\*(R^w\_i\*Pt\_{imu}+t^w\_i）+pd\_4)}{\partial R^w\_i} = \tfrac{\partial (normal\*Pt\_{world})}{\partial R^w\_i} = \tfrac{\partial (normal\*Pt\_{world})}{\partial Pt\_{world}}\*\tfrac{\partial (Pt\_{world})}{\partial R^w\_i} \\= normal\*\tfrac{\partial (R^w\_i\*Pt\_{imu}+t^w\_i)}{\partial R^w\_i} \\=normal\*(-{R^w\_i}\*\lfloor Pt\_{imu}\rfloor)$

其中，$\tfrac{\partial (R^w\_i\*Pt\_{imu}+t^w\_i)}{\partial R^w\_i} =-{R^w\_i}\*\lfloor Pt\_{imu}\rfloor$，对旋转使用右扰动模型

第一部分对平移求导：

$\tfrac{\partial (normal\*(R^w\_i\*Pt\_{imu}+t^w\_i）+pd\_4)}{\partial t^w\_i} = normal$

链式法则第二部分的近似有：

$\tfrac{\partial X}{\partial \delta X} = I$

综上：

$H=normal\*(-{R^w\_i}\*\lfloor Pt\_{imu}\rfloor | I\_{3X3})$

lidar inertial odometry模块对应代码如下：

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/7jP2lRDv7DQJq8g5/img/8c93c85c-65a5-43db-8e12-3f4eb86f7efe.png)

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/7jP2lRDv7DQJq8g5/img/1ffa4945-59e7-4f58-8ac2-02c89b33682d.png)

## 4.2 量测更新

## 4.2.1 

kalman标准更新过程为：

求解卡尔曼增益:

$K=P\_{predict}H^T(HP\_{predict}H^T+V)^{-1}$

更新状态：

$\delta X = K(z-h(\^{X}))$, (Note: 代码中的ptToPlaneDist(...)距离对应的是$h(\^{X})$，所以代码中距离前面有一个负号，$z$对应的是理论值0）

$\=X =  \^{X}+\delta X$

协方差更新：

$P\_{update}=(I-KH)P\_{predict}$

lidar inertial odometry模块对应代码如下：

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/7jP2lRDv7DQJq8g5/img/28a6d9c3-4c5d-4c47-8ae2-bbd5c8c82476.png)

## 4.2.2 ESKF RESET

# 5. 在线标定lidar 和 IMU外参 

[《手持设备各传感器外参关系参考》](https://alidocs.dingtalk.com/i/nodes/P7QG4Yx2Jp7G4QD2u74BBw4GV9dEq3XD?utm_scene=person_space)

H矩阵求导原理同对位姿求导：

# 6.相机模型与投影

## 6.1 KannalaBrandt8模型

相机坐标系下三维点到像素坐标投影模型：

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/7jP2lRDv7DQJq8g5/img/f7646895-3b07-482a-bb59-71db3034f8ef.png)

像素对相机坐标系三维点的雅可比：

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/7jP2lRDv7DQJq8g5/img/28b305fb-c1c6-404a-932e-fada7ca87aee.png)